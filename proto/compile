# !/bin/bash

# compile for go
sudo mkdir -p -m 777 $HATCHI_HOME/backend/proto
export PATH="$PATH:$(go env GOPATH)/bin" && \
  go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28 && \
  go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2 && \
  protoc -I $HATCHI_HOME/proto \
         --experimental_allow_proto3_optional \
         --go_out=$HATCHI_HOME/backend/proto/ \
         --go-grpc_out=$HATCHI_HOME/backend/proto/ \
         --go_opt=paths=source_relative \
         --go-grpc_opt=paths=source_relative \
         $HATCHI_HOME/proto/connectors.proto && \
         echo "Compile successful for Go"

# compile for flutter
sudo mkdir -p -m 777 $HATCHI_HOME/hatchi/lib/proto
export PATH="$PATH":"$HOME/.pub-cache/bin" && \
  cd $HATCHI_HOME/hatchi/ && dart pub global activate protoc_plugin && cd - && \
  protoc -I $HATCHI_HOME/proto \
         --dart_out=grpc:$HATCHI_HOME/hatchi/lib/proto \
         --experimental_allow_proto3_optional \
         $HATCHI_HOME/proto/connectors.proto && \
         echo "Compile successful for Flutter"
